<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#002868" />
  <title>HASP / Loadout PDF Tool — ERG</title>
  <link rel="manifest" href="./manifest.json" />
  <style>
    :root {
      --epa-blue: #002868;
      --epa-blue-hover: #003580;
      --epa-blue-light: #e8eef7;
      --epa-blue-highlight: #c5d4ed;
    }
    html, body { height: 100%; margin: 0; }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      background: #e8eef7;
      color: #1c1c1c;
      font-size: 16px;
      line-height: 1.4;
    }
    .shell { max-width: 100%; min-height: 100vh; display: flex; flex-direction: column; }

    .erg-link-block {
      flex-shrink: 0;
      background: #002868;
      color: #fff;
      padding: 0.625rem 1rem;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    .erg-link-block a {
      display: inline-block;
      color: #fff;
      background: #003580;
      font-weight: 600;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.25);
      transition: background 0.15s ease;
    }
    .erg-link-block a:hover, .erg-link-block a:focus {
      background: #004099;
      color: #fff;
      outline: 2px solid rgba(255,255,255,0.5);
      outline-offset: 2px;
    }

    main {
      flex: 1;
      padding: 1rem;
      max-width: 52rem;
      margin: 0 auto;
      width: 100%;
    }
    .load-msg { padding: 1rem; color: #444; }
    .load-err { color: #b00; font-weight: 500; }

    h1 { font-size: 1.35rem; color: #002868; margin: 0 0 0.5rem 0; }
    .subtitle { color: #555; font-size: 0.9375rem; margin: 0 0 1.25rem 0; }

    .mode-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.25rem;
      padding: 0.75rem 1rem;
      background: #fff;
      border: 1px solid #c5d4ed;
      border-radius: 6px;
    }
    .mode-row label { font-weight: 600; color: #002868; margin-right: 0.5rem; }
    .mode-row input[type="radio"] { margin: 0 0.25rem 0 0; }

    .panel { display: none; }
    .panel.active { display: block; }

    .form-section {
      margin-bottom: 1.25rem;
      padding: 1rem;
      background: #fff;
      border: 1px solid #c5d4ed;
      border-radius: 6px;
    }
    .form-section h2 {
      font-size: 1rem;
      color: #002868;
      margin: 0 0 0.5rem 0;
    }
    .form-section p.hint { font-size: 0.8125rem; color: #666; margin: 0 0 0.5rem 0; }
    .checkbox-list {
      max-height: 12rem;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 1rem;
    }
    .checkbox-list-single {
      display: flex;
      flex-direction: column;
      flex-wrap: nowrap;
      gap: 0.25rem;
      max-height: 14rem;
      overflow-y: auto;
    }
    .checkbox-list label,
    .checkbox-list-single label {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
      font-weight: normal;
      font-size: 0.875rem;
    }
    .checkbox-list input[type="checkbox"],
    .checkbox-list-single input[type="checkbox"] { margin: 0; }
    .checkbox-list-single label .part-no { font-size: 0.8125rem; color: #555; margin-left: 0.25rem; }

    .device-sensors {
      margin-top: 0.75rem;
      padding: 0.75rem;
      background: #e8eef7;
      border-radius: 4px;
    }
    .device-sensors h3 { font-size: 0.9375rem; color: #002868; margin: 0 0 0.5rem 0; }
    .device-sensors .sensor-list {
      max-height: 10rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      flex-wrap: nowrap;
      gap: 0.25rem;
    }
    .device-sensors .sensor-list label { display: flex; align-items: center; gap: 0.35rem; cursor: pointer; font-size: 0.875rem; }
    .device-sensors .sensor-list .part-no { font-size: 0.8125rem; color: #555; margin-left: 0.25rem; }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .meta-row label { display: block; font-size: 0.875rem; font-weight: 600; color: #002868; margin-bottom: 0.25rem; }
    .meta-row input[type="text"] {
      padding: 0.4rem 0.5rem;
      border: 1px solid #002868;
      border-radius: 4px;
      font-size: 0.875rem;
      min-width: 12rem;
    }

    .gen-row { margin-top: 1.25rem; }
    .gen-row button {
      padding: 0.6rem 1.25rem;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      background: #002868;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .gen-row button:hover { background: #003580; }
    .gen-row button:disabled { opacity: 0.6; cursor: not-allowed; }
    .status-msg { font-size: 0.875rem; color: #666; margin-top: 0.5rem; }
    .status-msg.err { color: #b00; }
  </style>
</head>
<body>
  <div class="shell">
    <header class="erg-link-block" role="banner">
      <a href="./index.html">← ERG Home</a>
      <a href="https://r9data.response.epa.gov/r9responseguide/MainPage/AirMonitoringTables.html" target="_blank" rel="noopener noreferrer">Open ERG Guide</a>
    </header>

    <main role="main">
      <p class="load-msg" id="load-msg">Loading reference data…</p>

      <div id="hasp-form" style="display: none;">
        <h1>HASP / Loadout PDF Tool</h1>
        <p class="subtitle">Build a field-ready PDF: start with chemical(s) or instrument(s), then pick compatible instruments and sensors. Output is suitable for a HASP or device loadout sheet.</p>

        <div class="mode-row">
          <label>Start with:</label>
          <label><input type="radio" name="mode" value="chemical" checked /> Chemical(s)</label>
          <label><input type="radio" name="mode" value="instrument" /> Instrument(s)</label>
        </div>

        <div id="panel-chemical" class="panel active">
          <div class="form-section">
            <h2>1. Select chemical(s)</h2>
            <p class="hint">Only devices that can detect at least one of these will appear next.</p>
            <div id="chem-list-chemical" class="checkbox-list checkbox-list-single"></div>
          </div>
          <div class="form-section">
            <h2>2. Select instrument(s)</h2>
            <p class="hint">Only instruments compatible with your selected chemical(s).</p>
            <div id="device-list-chemical" class="checkbox-list"></div>
          </div>
          <div class="form-section" id="sensors-section-chemical">
            <h2>3. Sensors per instrument</h2>
            <p class="hint">For each instrument you selected, choose which sensors are installed (only compatible sensors shown). Single column with part number.</p>
            <div id="device-sensors-chemical"></div>
          </div>
        </div>

        <div id="panel-instrument" class="panel">
          <div class="form-section">
            <h2>1. Select instrument(s)</h2>
            <p class="hint">Only chemicals detectable by at least one of these instruments will appear next.</p>
            <div id="device-list-instrument" class="checkbox-list"></div>
          </div>
          <div class="form-section">
            <h2>2. Select chemical(s)</h2>
            <p class="hint">Compatible with your instruments. Option to select all.</p>
            <div id="chem-list-instrument" class="checkbox-list checkbox-list-single"></div>
          </div>
          <div class="form-section" id="sensors-section-instrument">
            <h2>3. Sensors per instrument</h2>
            <p class="hint">For each instrument, choose which sensors are installed (only compatible sensors shown).</p>
            <div id="device-sensors-instrument"></div>
          </div>
        </div>

        <div class="form-section">
          <h2>Incident info (for PDF)</h2>
          <div class="meta-row">
            <div>
              <label for="meta-site">Site / Incident</label>
              <input type="text" id="meta-site" placeholder="e.g. Richmond Chevron — ER" />
            </div>
            <div>
              <label for="meta-incident">Incident #</label>
              <input type="text" id="meta-incident" placeholder="e.g. ER-2026-0214" />
            </div>
            <div>
              <label for="meta-by">Generated by</label>
              <input type="text" id="meta-by" placeholder="Your name" />
            </div>
          </div>
        </div>

        <div class="gen-row">
          <button type="button" id="btn-generate">Generate PDF (open print dialog)</button>
          <p class="status-msg" id="status-msg"></p>
        </div>
      </div>
    </main>
  </div>

  <script>
    (function () {
      const TABLE_URL = './air_monitoring_table.json';
      const SENSOR_PART_URL = './sensor_part_numbers.json';
      const CROSS_SENS_URL = './sensor_cross_sens.json';
      let allRows = [];
      let sensorPartNumbers = {};
      let sensorCrossSens = { displayNameToSensorIds: {}, bySensorId: {} };

      const loadMsg = document.getElementById('load-msg');
      const haspForm = document.getElementById('hasp-form');
      const statusMsg = document.getElementById('status-msg');
      const btnGenerate = document.getElementById('btn-generate');

      function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = String(s);
        return div.innerHTML;
      }

      function getDevicesForChemicals(chemicals) {
        if (!chemicals || !chemicals.length) return [];
        var devices = {};
        allRows.forEach(function (r) {
          var c = r['Target Compound'];
          var d = r['Device'];
          if (c != null && c !== '' && d != null && d !== '' && chemicals.indexOf(c) !== -1) devices[d] = true;
        });
        return Object.keys(devices).sort();
      }

      function getChemicalsForDevices(devices) {
        if (!devices || !devices.length) return [];
        var chemicals = {};
        allRows.forEach(function (r) {
          var c = r['Target Compound'];
          var d = r['Device'];
          if (c != null && c !== '' && d != null && d !== '' && devices.indexOf(d) !== -1) chemicals[c] = true;
        });
        return Object.keys(chemicals).sort();
      }

      function getSensorsForDevice(device) {
        if (!device) return [];
        var sensors = {};
        allRows.forEach(function (r) {
          if (r['Device'] === device && r['Sensor'] != null && r['Sensor'] !== '') sensors[r['Sensor']] = true;
        });
        return Object.keys(sensors).sort();
      }

      function getSensorsForChemicalsAndDevices(chemicals, devices) {
        if (!chemicals || !chemicals.length || !devices || !devices.length) return [];
        var sensors = {};
        allRows.forEach(function (r) {
          var c = r['Target Compound'];
          var d = r['Device'];
          var s = r['Sensor'];
          if (s != null && s !== '' && chemicals.indexOf(c) !== -1 && devices.indexOf(d) !== -1) sensors[s] = true;
        });
        return Object.keys(sensors).sort();
      }

      function getAllChemicals() {
        var chemicals = {};
        allRows.forEach(function (r) {
          var c = r['Target Compound'];
          if (c != null && c !== '') chemicals[c] = true;
        });
        return Object.keys(chemicals).sort();
      }

      function getAllDevices() {
        var devices = {};
        allRows.forEach(function (r) {
          var d = r['Device'];
          if (d != null && d !== '') devices[d] = true;
        });
        return Object.keys(devices).sort();
      }

      function renderCheckboxes(containerId, values, namePrefix, getChecked) {
        var container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        var checked = getChecked ? getChecked() : [];
        values.forEach(function (v) {
          var id = namePrefix + '-' + String(v).replace(/\s/g, '_').substring(0, 50);
          var label = document.createElement('label');
          var cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.id = id;
          cb.value = v;
          if (checked.indexOf(v) !== -1) cb.checked = true;
          label.appendChild(cb);
          label.appendChild(document.createTextNode(v.length > 45 ? v.substring(0, 45) + '…' : v));
          container.appendChild(label);
        });
      }

      function getCheckedFromList(containerId) {
        var container = document.getElementById(containerId);
        if (!container) return [];
        var out = [];
        container.querySelectorAll('input[type="checkbox"]:checked').forEach(function (cb) {
          if (cb.value && cb.id !== 'chem-i-selectall') out.push(cb.value);
        });
        return out;
      }

      function getSelectedSensorsPerDevice(prefix) {
        var out = {};
        document.querySelectorAll('[id^="sens-' + prefix + '-"]').forEach(function (cb) {
          if (cb.type !== 'checkbox' || !cb.checked) return;
          var device = cb.getAttribute('data-device');
          if (!device) return;
          if (!out[device]) out[device] = [];
          out[device].push(cb.value);
        });
        return out;
      }

      function buildChemicalPanel() {
        var chemChecked = getCheckedFromList('chem-list-chemical');
        var devList = chemChecked.length ? getDevicesForChemicals(chemChecked) : [];
        var devChecked = getCheckedFromList('device-list-chemical').filter(function (d) { return devList.indexOf(d) !== -1; });
        renderCheckboxes('chem-list-chemical', getAllChemicals(), 'chem-c', function () { return chemChecked; });
        renderCheckboxes('device-list-chemical', devList, 'dev-c', function () { return devChecked; });
        var container = document.getElementById('device-sensors-chemical');
        container.innerHTML = '';
        devChecked.forEach(function (device) {
          var sensors = getSensorsForChemicalsAndDevices(chemChecked, [device]);
          if (!sensors.length) return;
          var section = document.createElement('div');
          section.className = 'device-sensors';
          section.innerHTML = '<h3>' + escapeHtml(device) + '</h3><div class="sensor-list" id="sens-list-chemical-' + escapeHtml(device).replace(/\s/g, '_') + '"></div>';
          container.appendChild(section);
          var listEl = section.querySelector('.sensor-list');
          var existingChecked = getSelectedSensorsPerDevice('chemical')[device] || [];
          sensors.forEach(function (s) {
            var label = document.createElement('label');
            var cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.value = s;
            cb.setAttribute('data-device', device);
            cb.id = 'sens-chemical-' + escapeHtml(device + '-' + s).replace(/\s/g, '_').substring(0, 60);
            if (existingChecked.indexOf(s) !== -1) cb.checked = true;
            label.appendChild(cb);
            label.appendChild(document.createTextNode(s));
            if (sensorPartNumbers[s]) {
              var partSpan = document.createElement('span');
              partSpan.className = 'part-no';
              partSpan.textContent = ' · ' + sensorPartNumbers[s];
              label.appendChild(partSpan);
            }
            listEl.appendChild(label);
          });
        });
      }

      function buildInstrumentPanel() {
        var devChecked = getCheckedFromList('device-list-instrument');
        var chemList = devChecked.length ? getChemicalsForDevices(devChecked) : [];
        var chemChecked = getCheckedFromList('chem-list-instrument').filter(function (c) { return chemList.indexOf(c) !== -1; });
        renderCheckboxes('device-list-instrument', getAllDevices(), 'dev-i', function () { return devChecked; });
        var chemContainer = document.getElementById('chem-list-instrument');
        chemContainer.innerHTML = '';
        if (chemList.length) {
          var selectAllLabel = document.createElement('label');
          var selectAllCb = document.createElement('input');
          selectAllCb.type = 'checkbox';
          selectAllCb.id = 'chem-i-selectall';
          selectAllCb.checked = chemList.length === chemChecked.length && chemList.length > 0;
          selectAllLabel.appendChild(selectAllCb);
          selectAllLabel.appendChild(document.createTextNode(' Select all compatible chemicals'));
          chemContainer.appendChild(selectAllLabel);
          chemList.forEach(function (c) {
            var label = document.createElement('label');
            var cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.value = c;
            cb.id = 'chem-i-' + escapeHtml(c).replace(/\s/g, '_').substring(0, 50);
            if (chemChecked.indexOf(c) !== -1) cb.checked = true;
            label.appendChild(cb);
            label.appendChild(document.createTextNode(c.length > 45 ? c.substring(0, 45) + '…' : c));
            chemContainer.appendChild(label);
          });
          selectAllCb.addEventListener('change', function () {
            chemContainer.querySelectorAll('input[type="checkbox"]:not(#chem-i-selectall)').forEach(function (cb) {
              cb.checked = selectAllCb.checked;
            });
          });
        }
        var container = document.getElementById('device-sensors-instrument');
        container.innerHTML = '';
        devChecked.forEach(function (device) {
          var sensors = getSensorsForDevice(device);
          if (!sensors.length) return;
          var section = document.createElement('div');
          section.className = 'device-sensors';
          section.innerHTML = '<h3>' + escapeHtml(device) + '</h3><div class="sensor-list" id="sens-list-instrument-' + escapeHtml(device).replace(/\s/g, '_') + '"></div>';
          container.appendChild(section);
          var listEl = section.querySelector('.sensor-list');
          var existingChecked = getSelectedSensorsPerDevice('instrument')[device] || [];
          sensors.forEach(function (s) {
            var label = document.createElement('label');
            var cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.value = s;
            cb.setAttribute('data-device', device);
            cb.id = 'sens-instrument-' + escapeHtml(device + '-' + s).replace(/\s/g, '_').substring(0, 60);
            if (existingChecked.indexOf(s) !== -1) cb.checked = true;
            label.appendChild(cb);
            label.appendChild(document.createTextNode(s));
            if (sensorPartNumbers[s]) {
              var partSpan = document.createElement('span');
              partSpan.className = 'part-no';
              partSpan.textContent = ' · ' + sensorPartNumbers[s];
              label.appendChild(partSpan);
            }
            listEl.appendChild(label);
          });
        });
      }

      function onModeChange() {
        var mode = document.querySelector('input[name="mode"]:checked').value;
        document.getElementById('panel-chemical').classList.toggle('active', mode === 'chemical');
        document.getElementById('panel-instrument').classList.toggle('active', mode === 'instrument');
        if (mode === 'chemical') buildChemicalPanel();
        else buildInstrumentPanel();
      }

      function getSelections() {
        var mode = document.querySelector('input[name="mode"]:checked').value;
        var chemicals, devices, sensorsByDevice;
        if (mode === 'chemical') {
          chemicals = getCheckedFromList('chem-list-chemical');
          devices = getCheckedFromList('device-list-chemical');
          sensorsByDevice = getSelectedSensorsPerDevice('chemical');
        } else {
          chemicals = getCheckedFromList('chem-list-instrument');
          devices = getCheckedFromList('device-list-instrument');
          sensorsByDevice = getSelectedSensorsPerDevice('instrument');
        }
        return { mode: mode, chemicals: chemicals, devices: devices, sensorsByDevice: sensorsByDevice };
      }

      function buildPrintHtml(selections, site, incident, generatedBy) {
        var dateStr = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        var timeStr = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        var safe = function (x, d) { return (x != null && String(x).trim()) ? escapeHtml(String(x).trim()) : (d || '—'); };

        var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>HASP Loadout</title><style>';
        html += '@page { size: landscape; margin: 0.5in; }';
        html += 'body{font-family:Helvetica,Arial,sans-serif;font-size:11px;color:#222;margin:0;padding:0.5in;padding-bottom:1in;}';
        html += '.header{background:#1a3a5c;color:#fff;padding:12px 16px;margin:-0.5in -0.5in 16px -0.5in;}';
        html += '.header h1{margin:0;font-size:16px;} .header .sub{margin:4px 0 0 0;font-size:9px;color:#b0c8e0;}';
        html += '.meta{background:#e8f0f7;border:1px solid #4a7fb5;padding:8px 12px;margin-bottom:14px;display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:8px;}';
        html += '.meta label{font-weight:bold;color:#1a3a5c;font-size:9px;} .meta .val{font-size:10px;}';
        html += 'table{border-collapse:collapse;width:100%;max-width:100%;margin:10px 0;font-size:10px;table-layout:fixed;}';
        html += 'th,td{border:1px solid #ccc;padding:5px 6px;text-align:left;word-wrap:break-word;overflow-wrap:break-word;}';
        html += 'th{background:#1a3a5c;color:#fff;font-size:9px;}';
        html += 'th.col-detection,td.col-detection{font-weight:bold;}';
        html += 'td.col-detection{background:#e8f0f7;}';
        html += '.device-block{margin:0 0 18px 0;padding:12px 12px 12px 16px;background:#e8eef7;border-left:4px solid #002868;page-break-inside:avoid;max-width:100%;}';
        html += '.device-block:not(.first-device){page-break-before:always;}';
        html += '.device-block h2{margin:0 0 10px 0;font-size:13px;color:#002868;font-weight:bold;}';
        html += '.sensor-block{margin:12px 0;padding:0;background:#fff;border:1px solid #c5d4ed;box-sizing:border-box;max-width:100%;}';
        html += '.sensor-bar{background:#4a7fb5;color:#fff;padding:6px 10px;font-size:11px;font-weight:bold;}';
        html += '.sensor-block .sensor-body{padding:10px;max-width:100%;box-sizing:border-box;}';
        html += '.cross-sens{margin-top:10px;}';
        html += '.cross-sens h4{margin:0 0 6px 0;font-size:10px;color:#1a3a5c;}';
        html += '.chem-summary{margin:6px 0 10px 0;font-size:10px;line-height:1.4;}';
        html += '.foot{font-size:9px;color:#666;text-align:center;margin-top:28px;padding-top:12px;}';
        html += 'tr.context-row td{background:#e8eef7;font-size:9px;padding:4px 6px;border:1px solid #c5d4ed;}';
        html += '.sensor-pn{font-weight:normal;opacity:0.95;}';
        html += '@media print{.no-print{display:none;} body{padding:0.5in;padding-bottom:1in;} .header{margin:-0.5in -0.5in 16px -0.5in;} thead{display:table-header-group;} table{page-break-inside:auto;}}';
        html += '</style></head><body>';

        html += '<p class="no-print" style="margin:0 0 10px 0;padding:8px 12px;background:#fff3cd;border:1px solid #856404;font-size:12px;">Tip: Choose <strong>Landscape</strong> orientation in the print dialog for best results.</p>';
        html += '<div class="header"><h1>EPA EMERGENCY RESPONSE</h1><p class="sub">Field Equipment Loadout / HASP Reference</p></div>';
        html += '<div class="meta">';
        html += '<div><label>SITE / INCIDENT</label><div class="val">' + safe(site) + '</div></div>';
        html += '<div><label>INCIDENT NO.</label><div class="val">' + safe(incident) + '</div></div>';
        html += '<div><label>GENERATED BY</label><div class="val">' + safe(generatedBy) + '</div></div>';
        html += '<div><label>DATE</label><div class="val">' + dateStr + ' ' + timeStr + '</div></div>';
        html += '</div>';

        var devices = selections.devices || [];
        var sensorsByDevice = selections.sensorsByDevice || {};
        var chemicals = selections.chemicals || [];

        allRows.forEach(function (r) {
          r._chem = r['Target Compound'];
          r._dev = r['Device'];
          r._sens = r['Sensor'];
        });

        if (selections.mode === 'instrument' && devices.length) {
          var displayToIds = sensorCrossSens.displayNameToSensorIds || {};
          var bySensorId = sensorCrossSens.bySensorId || {};
          var firstDevice = true;
          devices.forEach(function (device) {
            var sensorIds = (sensorsByDevice[device] || []);
            if (!sensorIds.length) return;
            var deviceClass = 'device-block' + (firstDevice ? ' first-device' : '');
            firstDevice = false;
            html += '<div class="' + deviceClass + '"><h2>' + escapeHtml(device) + ' — ' + sensorIds.length + ' sensor(s) selected</h2>';
            sensorIds.forEach(function (sensorDisplayName) {
              var rows = allRows.filter(function (r) { return r._dev === device && r._sens === sensorDisplayName; });
              var chemRows = chemicals.length ? rows.filter(function (r) { return chemicals.indexOf(r._chem) !== -1; }) : rows;
              var hasChemRows = chemRows.length > 0;
              var sensorIdsForLookup = displayToIds[sensorDisplayName] || [];
              var crossList = [];
              sensorIdsForLookup.forEach(function (sid) {
                var arr = bySensorId[sid] || [];
                arr.forEach(function (x) { crossList.push(x); });
              });
              if (!hasChemRows && !crossList.length) return;
              var partNo = sensorPartNumbers[sensorDisplayName];
              var sensorBarText = escapeHtml(sensorDisplayName) + (partNo ? ' <span class="sensor-pn">· ' + escapeHtml(partNo) + '</span>' : '');
              html += '<div class="sensor-block"><div class="sensor-bar">' + sensorBarText + '</div><div class="sensor-body">';
              if (hasChemRows) {
                var contextLine = escapeHtml(device) + ' — ' + escapeHtml(sensorDisplayName) + (partNo ? ' · PN: ' + escapeHtml(partNo) : '');
                html += '<table><colgroup><col style="width:22%"><col style="width:14%"><col style="width:5%"><col style="width:5%"><col style="width:8%"><col style="width:8%"><col style="width:6%"><col style="width:6%"><col style="width:6%"><col style="width:6%"><col style="width:6%"><col style="width:8%"></colgroup><thead><tr class="context-row"><td colspan="12">' + contextLine + '</td></tr><tr><th>Target compound</th><th class="col-detection">Detection level</th><th>IP (eV)</th><th>Corr.</th><th>PEL</th><th>REL</th><th>TLV</th><th>IDLH</th><th>PAC-1</th><th>PAC-2</th><th>PAC-3</th><th>Air sampling</th></tr></thead><tbody>';
                chemRows.forEach(function (row) {
                  html += '<tr><td>' + safe(row._chem) + '</td><td class="col-detection">' + safe(row['Detection Level']) + '</td><td>' + safe(row['Ionization Potential (eV)']) + '</td><td>' + safe(row['Correction Factor']) + '</td><td>' + safe(row['PEL']) + '</td><td>' + safe(row['REL']) + '</td><td>' + safe(row['TLV']) + '</td><td>' + safe(row['IDLH']) + '</td><td>' + safe(row['PAC-1']) + '</td><td>' + safe(row['PAC-2']) + '</td><td>' + safe(row['PAC-3']) + '</td><td>' + safe(row['Air Sampling Method']) + '</td></tr>';
                });
                html += '</tbody></table>';
              }
              if (crossList.length) {
                var hasFilter = crossList.some(function (x) { return (x.response_type || '').toLowerCase().indexOf('filter') !== -1; });
                var crossContextLine = escapeHtml(device) + ' — ' + escapeHtml(sensorDisplayName) + (partNo ? ' · PN: ' + escapeHtml(partNo) : '');
                html += '<div class="cross-sens"><h4>Cross-sensitivities (interferents)</h4>';
                if (hasFilter) {
                  html += '<table><colgroup><col style="width:22%"><col style="width:12%"><col style="width:18%"><col style="width:18%"><col style="width:30%"></colgroup><thead><tr class="context-row"><td colspan="5">' + crossContextLine + '</td></tr><tr><th>Interferent</th><th>Test conc.</th><th>Response</th><th>Filtered response</th><th>Notes</th></tr></thead><tbody>';
                  crossList.forEach(function (x) {
                    var resp = safe(x.response_reading) + (x.observed_rdg_unit ? ' ' + x.observed_rdg_unit : '');
                    var filt = (x.filtered_resp_reading != null && String(x.filtered_resp_reading).trim()) ? (safe(x.filtered_resp_reading) + (x.filtered_rdg_unit ? ' ' + x.filtered_rdg_unit : '')) : '—';
                    html += '<tr><td>' + safe(x.chemical_id) + '</td><td>' + safe(x.test_concentration) + (x.test_conc_unit ? ' ' + x.test_conc_unit : '') + '</td><td>' + resp + '</td><td>' + filt + '</td><td>' + safe(x.notes) + '</td></tr>';
                  });
                  html += '</tbody></table></div>';
                } else {
                  html += '<table><colgroup><col style="width:28%"><col style="width:15%"><col style="width:22%"><col style="width:35%"></colgroup><thead><tr class="context-row"><td colspan="4">' + crossContextLine + '</td></tr><tr><th>Interferent</th><th>Test conc.</th><th>Response</th><th>Notes</th></tr></thead><tbody>';
                  crossList.forEach(function (x) {
                    var resp = safe(x.response_reading) + (x.observed_rdg_unit ? ' ' + x.observed_rdg_unit : '');
                    html += '<tr><td>' + safe(x.chemical_id) + '</td><td>' + safe(x.test_concentration) + (x.test_conc_unit ? ' ' + x.test_conc_unit : '') + '</td><td>' + resp + '</td><td>' + safe(x.notes) + '</td></tr>';
                  });
                  html += '</tbody></table></div>';
                }
              }
              html += '</div></div>';
            });
            html += '</div>';
          });
        } else if (selections.mode === 'chemical' && chemicals.length && devices.length) {
          html += '<p><strong>Selected chemicals:</strong> ' + chemicals.map(function (c) { return escapeHtml(c); }).join('; ') + '</p>';
          html += '<p><strong>Instruments on site:</strong> ' + devices.map(function (d) { return escapeHtml(d); }).join('; ') + '</p>';
          chemicals.forEach(function (chem) {
            var chemRows = allRows.filter(function (r) { return r._chem === chem && devices.indexOf(r._dev) !== -1; });
            var sensorSet = {};
            sensorsByDevice && Object.keys(sensorsByDevice).forEach(function (dev) {
              (sensorsByDevice[dev] || []).forEach(function (s) { sensorSet[s] = true; });
            });
            chemRows = chemRows.filter(function (r) { return sensorSet[r._sens]; });
            if (!chemRows.length) return;
            var first = chemRows[0];
            html += '<div class="device-block">';
            html += '<h2>' + escapeHtml(chem) + '</h2>';
            html += '<p class="chem-summary">IP: ' + safe(first['Ionization Potential (eV)']) + ' &middot; PEL: ' + safe(first['PEL']) + ' &middot; REL: ' + safe(first['REL']) + ' &middot; TLV: ' + safe(first['TLV']) + ' &middot; IDLH: ' + safe(first['IDLH']) + '</p>';
            html += '<p class="chem-summary">PAC-1: ' + safe(first['PAC-1']) + ' &middot; PAC-2: ' + safe(first['PAC-2']) + ' &middot; PAC-3: ' + safe(first['PAC-3']) + ' &middot; Air sampling: ' + safe(first['Air Sampling Method']) + '</p>';
            html += '<table><colgroup><col style="width:10%"><col style="width:16%"><col style="width:14%"><col style="width:5%"><col style="width:5%"><col style="width:8%"><col style="width:8%"><col style="width:6%"><col style="width:6%"><col style="width:6%"><col style="width:6%"><col style="width:6%"></colgroup><thead><tr><th>Device</th><th>Sensor</th><th class="col-detection">Detection level</th><th>Corr.</th><th>IP (eV)</th><th>PEL</th><th>REL</th><th>TLV</th><th>IDLH</th><th>PAC-1</th><th>PAC-2</th><th>PAC-3</th></tr></thead><tbody>';
            chemRows.forEach(function (row) {
              html += '<tr><td>' + safe(row._dev) + '</td><td>' + safe(row._sens) + '</td><td class="col-detection">' + safe(row['Detection Level']) + '</td><td>' + safe(row['Correction Factor']) + '</td><td>' + safe(row['Ionization Potential (eV)']) + '</td><td>' + safe(row['PEL']) + '</td><td>' + safe(row['REL']) + '</td><td>' + safe(row['TLV']) + '</td><td>' + safe(row['IDLH']) + '</td><td>' + safe(row['PAC-1']) + '</td><td>' + safe(row['PAC-2']) + '</td><td>' + safe(row['PAC-3']) + '</td></tr>';
            });
            html += '</tbody></table></div>';
          });
        }

        html += '<p class="foot">PEL = OSHA Permissible Exposure Limit. IDLH = Immediately Dangerous to Life or Health. Verify instrument calibration before deployment. EPA Region 9 — Air Monitoring Reference — DRAFT, NOT FOR REGULATORY USE.</p>';
        html += '</body></html>';
        return html;
      }

      function openPrintWindow() {
        var sel = getSelections();
        var mode = sel.mode;
        var chemicals = sel.chemicals;
        var devices = sel.devices;
        var sensorsByDevice = sel.sensorsByDevice;
        var hasSensors = Object.keys(sensorsByDevice).some(function (dev) { return (sensorsByDevice[dev] || []).length > 0; });

        if (!devices.length) {
          statusMsg.textContent = 'Select at least one instrument.';
          statusMsg.classList.add('err');
          return;
        }
        if (!hasSensors) {
          statusMsg.textContent = 'Select at least one sensor for your instrument(s).';
          statusMsg.classList.add('err');
          return;
        }
        if (mode === 'chemical' && !chemicals.length) {
          statusMsg.textContent = 'Select at least one chemical.';
          statusMsg.classList.add('err');
          return;
        }
        if (mode === 'instrument' && !chemicals.length) {
          statusMsg.textContent = 'Select at least one chemical (or use Select all).';
          statusMsg.classList.add('err');
          return;
        }

        statusMsg.textContent = '';
        statusMsg.classList.remove('err');

        var site = (document.getElementById('meta-site') && document.getElementById('meta-site').value) || '';
        var incident = (document.getElementById('meta-incident') && document.getElementById('meta-incident').value) || '—';
        var generatedBy = (document.getElementById('meta-by') && document.getElementById('meta-by').value) || '';

        var printHtml = buildPrintHtml(sel, site, incident, generatedBy);
        var w = window.open('', '_blank');
        w.document.write(printHtml);
        w.document.close();
        w.focus();
        setTimeout(function () {
          w.print();
          w.close();
        }, 300);
      }

      document.querySelectorAll('input[name="mode"]').forEach(function (radio) {
        radio.addEventListener('change', onModeChange);
      });

      document.getElementById('chem-list-chemical').addEventListener('change', buildChemicalPanel);
      document.getElementById('device-list-chemical').addEventListener('change', buildChemicalPanel);
      document.getElementById('device-list-instrument').addEventListener('change', buildInstrumentPanel);
      document.getElementById('chem-list-instrument').addEventListener('change', function () {
        var list = document.getElementById('chem-list-instrument');
        var selectAll = document.getElementById('chem-i-selectall');
        if (selectAll) {
          var total = list.querySelectorAll('input[type="checkbox"]:not(#chem-i-selectall)').length;
          var checked = list.querySelectorAll('input[type="checkbox"]:checked').length;
          if (total > 0) selectAll.checked = checked === total;
        }
      });

      btnGenerate.addEventListener('click', openPrintWindow);

      Promise.all([
        fetch(TABLE_URL).then(function (r) {
          if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
          return r.json();
        }),
        fetch(SENSOR_PART_URL).then(function (r) {
          if (!r.ok) return {};
          return r.json();
        }).catch(function () { return {}; }),
        fetch(CROSS_SENS_URL).then(function (r) {
          if (!r.ok) return { displayNameToSensorIds: {}, bySensorId: {} };
          return r.json();
        }).catch(function () { return { displayNameToSensorIds: {}, bySensorId: {} }; })
      ]).then(function (results) {
        allRows = Array.isArray(results[0]) ? results[0] : (results[0].rows != null ? results[0].rows : []);
        sensorPartNumbers = results[1] || {};
        sensorCrossSens = results[2] || { displayNameToSensorIds: {}, bySensorId: {} };
        loadMsg.style.display = 'none';
        haspForm.style.display = 'block';
        buildChemicalPanel();
      }).catch(function (err) {
        loadMsg.textContent = 'Could not load table: ' + err.message;
        loadMsg.classList.add('load-err');
      });

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(function () {});
      }
    })();
  </script>
</body>
</html>
